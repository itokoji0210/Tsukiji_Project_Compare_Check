<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>定点・ビフォーアフター比較（フェード量スライダー対応）</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b0e12; --fg:#e9edf3; --muted:#9aa3b2; --card:#151a22; --border:#273041;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --ar: 16 / 9; /* 動的に書き換え（画像の実アスペクト比） */
  }
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic", Meiryo, sans-serif;
    line-height:1.6;
    padding: calc(8px + var(--safe-top)) 0 calc(8px + var(--safe-bottom)) 0;
  }
  .container{
    width:100vw; /* 横幅いっぱい */
    margin:0 auto;
  }
  .panel{
    padding: 8px calc(10px + var(--safe-left)) 8px calc(10px + var(--safe-right));
  }
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px;
  }
  h1{font-size: clamp(18px, 2.6vw, 26px); margin: 2px 0 10px}
  .grid{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
  .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  label{font-size:13px; color:var(--muted)}
  select,button,input[type=range]{
    background:#0c1118; color:var(--fg);
    border:1px solid var(--border); border-radius:10px;
    padding:9px 10px; font-size:14px;
  }
  button{cursor:pointer}
  .hint{font-size:12px; color:var(--muted)}
  /* ビューア：横幅100vw・高さはアスペクト比で可変 */
  .viewerWrap{
    width:100vw; max-width:100vw; overflow:hidden;
  }
  .viewer{
    position:relative; width:100%; aspect-ratio: var(--ar);
    background:#0a0e13; border-top:1px solid var(--border); border-bottom:1px solid var(--border);
    user-select:none; touch-action:none;
  }
  .layer{ position:absolute; inset:0; display:grid; place-items:center; }
  .layer img{
    width:100%; height:100%; object-fit:contain;
    image-rendering:auto; transform:translateZ(0);
    will-change: opacity, clip-path;
  }
  .badge{
    position:absolute; top:10px; left:10px;
    background:rgba(0,0,0,.55); color:#fff; border:1px solid rgba(255,255,255,.12);
    font-size:12px; padding:6px 8px; border-radius:10px;
  }
  .badge.right{left:auto; right:10px}
  .sliderTrack{ position:absolute; inset:0; pointer-events:none; }
  .divider{ position:absolute; top:0; bottom:0; width:2px; background:rgba(255,255,255,.92); left:50% }
  .handle{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:44px; height:44px; border-radius:999px; display:grid; place-items:center;
    background:rgba(20,25,34,.9); border:1px solid rgba(255,255,255,.12);
    box-shadow:0 4px 16px rgba(0,0,0,.35);
  }
  .rangeRow{display:flex; align-items:center; gap:8px}
  .rangeRow input[type=range]{flex:1; height:36px}
  /* ステータス行 */
  .status{ display:flex; gap:12px; align-items:center; font-size:12px; color:var(--muted); }
  .status strong{ color:var(--fg); font-weight:600 }
</style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>定点撮影｜ビフォー・アフター比較（フェード量スライダー対応）</h1>
      <div class="card">
        <div class="grid">
          <div>
            <label>左（古い）</label>
            <select id="leftSelect" aria-label="左の画像（古い）"></select>
          </div>
          <div>
            <label>右（新しい）</label>
            <select id="rightSelect" aria-label="右の画像（新しい）"></select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="modeBtn">モード：フェード（メイン）</button>
          <button id="toggleBtn">古い ↔ 新しい（ワンタップ切替）</button>
        </div>

        <!-- フェード用スライダー（新規） -->
        <div class="rangeRow" id="fadeRow" style="margin-top:8px">
          <label>フェード</label>
          <input id="fadeRange" type="range" min="0" max="100" value="0" aria-label="フェード量（%）">
          <span class="hint" id="fadePct">0%</span>
        </div>

        <!-- 切り替えスライダー（サブ） -->
        <div class="rangeRow" id="cutRow" style="margin-top:8px; display:none">
          <label>スライダー</label>
          <input id="cutRange" type="range" min="0" max="100" value="50" aria-label="スライダー位置（%）">
          <span class="hint" id="cutPct">50%</span>
        </div>

        <div class="status" style="margin-top:6px">
          <div>表示モード：<strong id="modeLabel">フェード</strong></div>
          <div>左：<strong id="leftLabel">-</strong></div>
          <div>右：<strong id="rightLabel">-</strong></div>
        </div>
        <div class="hint" style="margin-top:6px">
          画像上のドラッグ：フェード時＝フェード量、スライダー時＝境界位置を調整。左右キーでも微調整できます。
        </div>
      </div>
    </div>

    <div class="viewerWrap">
      <div class="viewer" id="viewer">
        <div class="layer" id="layerA">
          <img id="imgA" alt="左（古い）画像">
          <div class="badge">左：古い</div>
        </div>
        <div class="layer" id="layerB" style="opacity:0">
          <img id="imgB" alt="右（新しい）画像">
          <div class="badge right">右：新しい</div>
        </div>
        <div class="sliderTrack" id="track" style="display:none">
          <div class="divider" id="divider"></div>
          <div class="handle" id="handle"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========== ユーザー編集エリア：画像リストだけ覚えればOK ========== */
const IMAGES = [
  "2025_08_04.jpg",
  "2025_08_20.JPG",
  "2025_10_07.jpg"
];
const DEFAULT_LEFT  = "2025_08_04.jpg";
const DEFAULT_RIGHT = "2025_10_07.jpg";
/* ================================================================ */

const $ = (id)=>document.getElementById(id);
const leftSelect = $('leftSelect'), rightSelect = $('rightSelect');
const imgA=$('imgA'), imgB=$('imgB'), layerA=$('layerA'), layerB=$('layerB');
const modeBtn=$('modeBtn'), toggleBtn=$('toggleBtn');
const fadeRow=$('fadeRow'), fadeRange=$('fadeRange'), fadePct=$('fadePct');
const cutRow=$('cutRow'), cutRange=$('cutRange'), cutPct=$('cutPct');
const modeLabel=$('modeLabel'), leftLabel=$('leftLabel'), rightLabel=$('rightLabel');
const viewer=$('viewer'), track=$('track'), divider=$('divider'), handle=$('handle');

let mode='fade';   // 'fade' | 'slider'
let dragging=false;

function labelFromFilename(fn){
  const m = fn.match(/^(\d{4})_(\d{2})_(\d{2})/);
  return m ? `${m[1]}-${m[2]}-${m[3]}` : fn;
}
function ymd(fn){ const m=fn.match(/^(\d{4})_(\d{2})_(\d{2})/); return m? `${m[1]}-${m[2]}-${m[3]}`: null; }
function isOlder(a,b){ const A=ymd(a), B=ymd(b); return !A||!B||A<=B; }

function populate(){
  [leftSelect,rightSelect].forEach(sel=>{
    sel.innerHTML='';
    IMAGES.forEach(fn=>{
      const o=document.createElement('option');
      o.value=fn; o.textContent=labelFromFilename(fn);
      sel.appendChild(o);
    });
  });
  leftSelect.value=DEFAULT_LEFT;
  rightSelect.value=DEFAULT_RIGHT;
  enforceChronology();
}
function enforceChronology(){
  const L=leftSelect.value, R=rightSelect.value;
  if(!isOlder(L,R)){ leftSelect.value=R; rightSelect.value=L; }
  leftLabel.textContent=labelFromFilename(leftSelect.value);
  rightLabel.textContent=labelFromFilename(rightSelect.value);
  loadImages();
}
function preload(src){ const i=new Image(); i.src=src; }

function setAspectByImages(){
  // 読み込み済みの自然サイズから viewer の aspect-ratio を動的に設定
  const wa = imgA.naturalWidth, ha = imgA.naturalHeight;
  const wb = imgB.naturalWidth, hb = imgB.naturalHeight;
  if(wa>0 && ha>0 && wb>0 && hb>0){
    // 2枚のうち「縦がより大きくなりがち」なアスペクト比を採用（縦切れ回避）
    const ra = wa/ha, rb = wb/hb;
    const r = Math.min(ra, rb); // より縦長寄りを使う
    viewer.style.setProperty('--ar', `${r} / 1`);
  }
}

function loadImages(){
  const L=leftSelect.value, R=rightSelect.value;
  preload(L); preload(R);
  imgA.style.opacity='1';
  imgB.style.opacity= mode==='fade' ? (fadeRange.value/100) : '1';
  imgA.src=L; imgB.src=R;
  imgA.alt=`左（古い）：${labelFromFilename(L)}`;
  imgB.alt=`右（新しい）：${labelFromFilename(R)}`;
  // アスペクト比を画像ロード後に更新
  const onReady = ()=> setAspectByImages();
  if(imgA.complete && imgB.complete){ onReady(); }
  else{
    imgA.onload = onReady; imgB.onload = onReady;
  }
  if(mode==='slider'){
    setCut(cutRange.value);
  }
}

function setMode(next){
  mode = next;
  modeLabel.textContent = (mode==='fade') ? 'フェード' : 'スライダー';
  if(mode==='fade'){
    modeBtn.textContent='モード：フェード（メイン）';
    fadeRow.style.display='';
    cutRow.style.display='none';
    track.style.display='none';
    viewer.style.cursor='ew-resize'; // ドラッグでフェード調整
    setFade(fadeRange.value);
  }else{
    modeBtn.textContent='モード：スライダー（サブ）';
    fadeRow.style.display='none';
    cutRow.style.display='';
    track.style.display='';
    viewer.style.cursor='ew-resize';
    setCut(cutRange.value);
  }
}

function setFade(v){
  const p = Math.max(0, Math.min(100, Number(v)));
  fadeRange.value = p;
  fadePct.textContent = p + '%';
  // B（右＝新しい）の不透明度を p% に
  layerA.style.opacity = 1;
  layerB.style.opacity = p/100;
}
function setCut(v){
  const p = Math.max(0, Math.min(100, Number(v)));
  cutRange.value = p;
  cutPct.textContent = p + '%';
  // スライダー表示：Bを上にして左からp%まで表示
  layerA.style.opacity = 1;
  layerB.style.opacity = 1;
  const x = p.toFixed(2);
  imgB.style.clipPath = `inset(0 ${100 - x}% 0 0)`;
  divider.style.left = x + '%';
  handle.style.left = x + '%';
}

function pointerToPercent(clientX){
  const rect = viewer.getBoundingClientRect();
  const x = Math.max(rect.left, Math.min(clientX, rect.right));
  const p = ((x - rect.left) / rect.width) * 100;
  return p;
}

/* === イベント === */
leftSelect.addEventListener('change', enforceChronology);
rightSelect.addEventListener('change', enforceChronology);

modeBtn.addEventListener('click', ()=> setMode(mode==='fade' ? 'slider' : 'fade'));
toggleBtn.addEventListener('click', ()=>{
  // フェードのワンタップ切替（0% <-> 100%）
  if(mode==='fade'){
    const next = (Number(fadeRange.value) < 50) ? 100 : 0;
    setFade(next);
  }else{
    // スライダーの中央⇔端寄せトグル
    const next = (Number(cutRange.value) !== 50) ? 50 : 100;
    setCut(next);
  }
});
fadeRange.addEventListener('input', e=> setFade(e.target.value));
cutRange.addEventListener('input',  e=> setCut(e.target.value));

let activePointerId=null;
viewer.addEventListener('pointerdown', (e)=>{
  activePointerId = e.pointerId;
  viewer.setPointerCapture?.(activePointerId);
  dragging = true;
  const p = pointerToPercent(e.clientX);
  if(mode==='fade'){ setFade(p); } else { setCut(p); }
});
window.addEventListener('pointermove', (e)=>{
  if(!dragging) return;
  const p = pointerToPercent(e.clientX);
  if(mode==='fade'){ setFade(p); } else { setCut(p); }
});
['pointerup','pointercancel','pointerleave'].forEach(type=>{
  window.addEventListener(type, ()=>{
    dragging=false;
    if(activePointerId!=null){ viewer.releasePointerCapture?.(activePointerId); activePointerId=null; }
  });
});

window.addEventListener('keydown', (e)=>{
  const step = (e.shiftKey? 5 : 1);
  if(e.key==='s' || e.key==='S'){
    setMode(mode==='fade' ? 'slider' : 'fade');
  }else if(mode==='fade' && (e.key==='ArrowLeft' || e.key==='ArrowRight')){
    const cur = Number(fadeRange.value);
    setFade(cur + (e.key==='ArrowRight' ? step : -step));
  }else if(mode==='slider' && (e.key==='ArrowLeft' || e.key==='ArrowRight')){
    const cur = Number(cutRange.value);
    setCut(cur + (e.key==='ArrowRight' ? step : -step));
  }else if(e.key==='f' || e.key==='F'){
    // フェードのワンタップ
    if(mode==='fade'){
      const next = (Number(fadeRange.value) < 50) ? 100 : 0;
      setFade(next);
    }
  }
});

/* 初期化 */
populate();
setMode('fade');          // フェードをデフォルト
setFade(0);               // 初期は古い100%
/* 画像プリロード */
IMAGES.forEach(preload);
</script>
</body>
</html>
